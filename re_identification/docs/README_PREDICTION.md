# Re-Identification Prediction

Our prediction service is a simple and efficient tool that allows users to upload their TensorFlow Lite (.tflite) or Keras (.keras) re-identification model and a set of images for prediction. The service then uses the model to extract features or predict the identity for each image in the set. This can be particularly useful for anyone working with person re-identification tasks and looking for a quick and easy way to generate predictions or feature embeddings. Our prediction service is designed to be user-friendly and accessible, making it an ideal solution for both beginners and experts alike.

<details open>
<summary><a href="#1"><b>1. Configure the YAML file</b></a></summary><a id="1"></a>

To use the prediction service, users must fill in the 'prediction' section of the [user_config.yaml](../user_config.yaml) file like the [prediction_config.yaml](../config_file_examples/prediction_config.yaml) or as shown in the example below:

```yaml
model:
   model_path: ../../stm32ai-modelzoo/re_identification/osnet/ST_pretrainedmodel_public_dataset/DeepSportradar/osnet_a100_256_128_tfs/osnet_a100_256_128_tfs_int8.tflite

operation_mode: prediction

dataset:
   dataset_name: DeepSportradar
   prediction_query_path: ./datasets/DeepSportradar-ReID/reid_test/query
   prediction_gallery_path: ./datasets/DeepSportradar-ReID/reid_test/gallery

prediction:
   reid_distance_metric: 'cosine' # options: 'euclidean', 'cosine'
   target: 'host'

preprocessing:
   rescaling:
      scale: 1/127.5
      offset: -1
   resizing:
      interpolation: nearest
      aspect_ratio: fit
   color_mode: rgb
```

In the 'model' section, users must provide the path to their model file using the `model_path` attribute. This can be either a Keras model file with a '.keras' filename extension (float model) or a TensorFlow Lite model file with a '.tflite' filename extension (quantized model).

The 'dataset' section requires users to provide the 'dataset_name', the 'prediction_query_path ' and 'prediction_gallery_path' attributes, which specify the paths to the query and gallery image folders, respectively. The prediction will predict the identities of the images in the query folder by comparing them to the images in the gallery folder (the closest image in the gallery will be considered as the same identity as the query image).

Here is an example of the output display of the prediction:

![ReID Prediction Example](./img/ReID_prediction_example.png)

In the 'prediction' section, the `reid_distance_metric` attribute allows users to choose the distance metric for re-identification, with options being 'euclidean' or 'cosine'. 

If users are using a quantized TFLITE or ONNX model, they can decide to do the inferences with the classic Python interpreters (host -> by default), with the C code generated by stedgeai on the PC (stedgeai_host), or with the C code generated by stedgeai on the N6 board directly (stedgeai_n6) using the `target` attribute.

### Hydra and MLflow Settings

The `mlflow` and `hydra` sections must always be present in the YAML configuration file. The `hydra` section can be used to specify the name of the directory where experiment directories are saved and/or the pattern used to name experiment directories. With the YAML code below, every time you run the Model Zoo, an experiment directory is created that contains all the directories and files created during the run. The names of experiment directories are all unique as they are based on the date and time of the run.

```yaml
hydra:
   run:
      dir: ./tf/src/experiments_outputs/${now:%Y_%m_%d_%H_%M_%S}
```

The `mlflow` section is used to specify the location and name of the directory where MLflow files are saved, as shown below:

```yaml
mlflow:
   uri: ./tf/src/experiments_outputs/mlruns
```

</details>

<details open>
<summary><a href="#2"><b>2. Launch the Prediction</b></a></summary><a id="2"></a>

If you chose to modify the [user_config.yaml](../user_config.yaml), you can evaluate the model by running the following command from the UC folder:

```bash
python stm32ai_main.py 
```
If you chose to update the [prediction_config.yaml](../config_file_examples/prediction_config.yaml) and use it, then run the following command from the UC folder:

```bash
python stm32ai_main.py --config-path ./config_file_examples/ --config-name prediction_config.yaml
```

</details>
